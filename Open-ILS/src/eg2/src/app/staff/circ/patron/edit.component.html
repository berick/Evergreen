<eg-string key="circ.patron.edit.test_notify.success" 
  i18n-text text="Test Notification Sent"></eg-string>
<eg-string key="circ.patron.edit.test_notify.fail" 
  i18n-text text="Test Notification Failed to Send"></eg-string>
<eg-string key="circ.patron.edit.invalidate.success" 
  i18n-text text="Field Invalidation Succeeded"></eg-string>
<eg-string key="circ.patron.edit.invalidate.fail" 
  i18n-text text="Failed to Invalidate Field"></eg-string>
<eg-string key="circ.patron.edit.grplink.success" 
  i18n-text text="Group Link Succeeded"></eg-string>
<eg-string key="circ.patron.edit.grplink.fail" 
  i18n-text text="Group Link Failed"></eg-string>

<eg-patron-secondary-groups [secondaryGroups]="secondaryGroups" #secondaryGroupsDialog>
</eg-patron-secondary-groups>

<div class="row" *ngIf="loading">
  <div class="col-lg-6 offset-lg-3">
    <eg-progress-inline></eg-progress-inline>
  </div>
</div>

<!-- IDL-generated field labels.  Override with args.overrideLabel -->
<ng-template #fieldLabel let-args="args">
  <div class="col-lg-3 field-label">
    <label for="{{getClass(args.cls)}}-{{args.field}}-input">
      {{getFieldLabel(getClass(args.cls), args.field, args.overrideLabel)}}
    </label>
    <!-- TODO doc links -->
  </div>
</ng-template>

<!-- text / number / email inputs -->
<ng-template #fieldInput let-args="args">
  <div class="col-lg-3">
    <input 
      type="{{args.type || 'text'}}"
      class="form-control" 
      name="{{getClass(args.cls)}}-{{args.field}}-input"
      id="{{getClass(args.cls)}}-{{args.field}}-input"
      [ngModel]="objectFromPath(args.path)[args.field]()"
      (ngModelChange)="fieldValueChange(args.path, args.field, $event)"
      (change)="afterFieldChange(args.path, args.field)"
      [required]="fieldRequired(getClass(args.cls), args.field)"
      [pattern]="fieldPattern(getClass(args.cls), args.field)"
      [disabled]="args.disabled"
    />
  </div>
</ng-template>

<!-- checkbox inputs -->
<ng-template #fieldCheckbox let-args="args">
  <div class="col-lg-3">
    <input 
      type="checkbox"
      class="form-check-input ml-0"
      name="{{getClass(args.cls)}}-{{args.field}}-input"
      id="{{getClass(args.cls)}}-{{args.field}}-input"
      [ngModel]="objectFromPath(args.path)[args.field]() == 't'"
      (ngModelChange)="fieldValueChange(args.path, args.field, $event)"
      (change)="afterFieldChange(args.path, args.field)"
      [required]="fieldRequired(getClass(args.cls), args.field)"
      [pattern]="fieldPattern(getClass(args.cls), args.field)"
      [disabled]="disabled"
    />
  </div>
</ng-template>

<!-- combobox inputs -->
<ng-template #fieldCombobox let-args="args">
  <div class="col-lg-3">
    <eg-combobox [entries]="args.entries"
      name="{{getClass(args.cls)}}-{{args.field}}-input"
      domId="{{getClass(args.cls)}}-{{args.field}}-input"
      [startId]="getFieldValue(args.path, args.field)"
      (onChange)="
        fieldValueChange(args.path, args.field, $event ? $event.id : null); 
        afterFieldChange(args.path, args.field)"
      [required]="fieldRequired(getClass(args.cls), args.field)"
      [disabled]="args.disabled">
    </eg-combobox>
  </div>
</ng-template>

<!-- like fieldRow below, but for user settings checkboxes -->
<ng-template #userSettingsCheckboxRow let-args="args">
  <div class="row pt-1 pb-1 mt-1">
    <div class="col-lg-3 field-label">
      <label for="cust-{{args.settingName}}-input">
        {{userSettingTypes[args.settingName].label()}}
      </label>
    </div>
    <div class="col-lg-3">
      <input 
        type="checkbox"
        class="form-check-input ml-0"
        name="cust-{{args.settingName}}-input"
        id="cust-{{args.setingName}-input"
        [ngModel]="userSettings[args.settingName]"
        (ngModelChange)="userSettingChange(args.settingName, $event)"
        [disabled]="args.disabled"
      />
    </div>
  </div>
</ng-template>

<!-- One row of label + field.  
    Used when a field requires no additional toggles. -->
<ng-template #fieldRow let-args="args">
  <div class="row pt-1 pb-1 mt-1" *ngIf="showField(args.cls, args.field)">
    <ng-container *ngTemplateOutlet="fieldLabel; context: {args: args}">
    </ng-container>
    <ng-container *ngTemplateOutlet="args.template; context: {args: args}">
    </ng-container>
  </div>
</ng-template>


<!-- The List O' Fields -->

<div class="mt-3 striped-rows-even patron-edit-container" *ngIf="patron">
  <ng-container *ngTemplateOutlet="fieldRow; context: {args: 
    {template: fieldInput, field: 'barcode', cls: 'ac', 
    path: 'card', disabled: !patron.isnew()}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'usrname'}}">
  </ng-container>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container *ngTemplateOutlet="fieldLabel; context: {args: {field: 'passwd'}}">
    </ng-container>
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {args: {field: 'passwd'}}">
    </ng-container>
    <div class="col-lg-3">
      <button class="btn btn-outline-dark" (click)="generatePassword()" i18n>
        Generate Password
      </button>
    </div>
  </div>

  <!-- Name / Preferred Name Tabs -->
  <ul ngbNav #nameNav="ngbNav" class="nav-tabs" [(activeId)]="nameTab">
    <li ngbNavItem="primary">
      <a ngbNavLink i18n>Primary Name</a>
      <ng-template ngbNavContent>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'prefix'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'first_given_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'second_given_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'family_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'suffix'}}">
        </ng-container>
      </ng-template>
    </li>
    <li ngbNavItem="preferred">
      <a ngbNavLink i18n>Preferred Name</a>
      <ng-template ngbNavContent>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'pref_prefix'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'pref_first_given_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'pref_second_given_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'pref_family_name'}}">
        </ng-container>
        <ng-container *ngTemplateOutlet="fieldRow; context: 
          {args: {template: fieldInput, field: 'pref_suffix'}}">
        </ng-container>
      </ng-template>
    </li>
  </ul>

  <!-- Container div for name / pref name tabs -->
  <div class="border rounded p-2" [ngClass]="{
    'border-primary': nameTab == 'primary', 
    'border-success': nameTab == 'preferred'}">
    <b>{{nameTab}}</b>
    <div [ngbNavOutlet]="nameNav"></div>
  </div>

  <div class="row pt-1 pb-1 mt-1" *ngIf="showField('au', 'name_keywords')">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'name_keywords'}}">
    </ng-container>
    <div class="col-lg-3">
      <textarea
        class="form-control" 
        name="au-name_keywords-input"
        id="au-name_keywords-input"
        [ngModel]="objectFromPath(null)['name_keywords']()"
        (ngModelChange)="fieldValueChange(null, 'name_keywords', $event)"
        (change)="afterFieldChange(null, 'name_keywords')"
        [required]="fieldRequired('au', 'name_keywords')"
        [pattern]="fieldPattern('au', 'name_keywords')">
      </textarea>
    </div>
  </div>

  <!-- example of overriding a field label -->
  <eg-string #holdAliasString i18n-text text="Holds Alias"></eg-string>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'alias', overrideLabel: holdAliasString.text}}">
  </ng-container>

  <div class="row pt-1 pb-1 mt-1" *ngIf="showField('au', 'dob')">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'dob'}}">
    </ng-container>
    <div class="col-lg-3">
      <eg-date-select
        domId="au-dob-input"
        fieldName="au-dob-input"
        [noMaxWidth]="true"
        [initialIso]="patron.dob()"
        (onChangeAsIso)="
          fieldValueChange(null, 'dob', $event); 
          afterFieldChange(null, 'dob')"
        [required]="fieldRequired('au', 'dob')">
      </eg-date-select>
    </div>
  </div>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldCheckbox, field: 'juvenile'}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'guardian'}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldCombobox, field: 'ident_type', entries: identTypes}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'ident_value'}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldCombobox, field: 'ident_type2', entries: identTypes}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'ident_value2'}}">
  </ng-container>


  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'email'}}">
    </ng-container>
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {args: {field: 'email', type: 'email'}}">
    </ng-container>
    <div class="col-lg-6">
      <button class="btn btn-outline-dark" 
        (click)="sendTestMessage('au.email.test')" i18n>
        Send Test Email
      </button>
      <button class="btn btn-outline-dark ml-2" 
        (click)="invalidateField('email')" i18n>Invalidate</button>
    </div>
  </div>

  <ng-container 
    *ngIf="userSettingTypes['circ.send_email_checkout_receipts'] && showField('au', 'email')">
    <ng-container *ngTemplateOutlet="userSettingsCheckboxRow; context: 
      {args: {settingName: 'circ.send_email_checkout_receipts'}}">
    </ng-container>
  </ng-container>

  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'day_phone'}}">
    </ng-container>
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {args: {field: 'day_phone'}}">
    </ng-container>
    <div class="col-lg-6">
      <button class="btn btn-outline-dark" 
        (click)="invalidateField('day_phone')" i18n>Invalidate</button>
    </div>
  </div>

  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'evening_phone'}}">
  </ng-container>
  <ng-container *ngTemplateOutlet="fieldRow; context: 
    {args: {template: fieldInput, field: 'other_phone'}}">
  </ng-container>

  <div class="row pt-1 pb-1 mt-1" *ngIf="showField('au', 'home_ou')">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'home_ou'}}">
    </ng-container>
    <div class="col-lg-3">
      <eg-org-select
        domId="au-home_ou-input"
        fieldName="au-home_ou-input"
        [initialOrgId]="patron.home_ou()"
        [disableOrgs]="cannotHaveUsersOrgs()"
        (onChange)="
          fieldValueChange(null, 'home_ou', $event ? $event.id() : null); 
          afterFieldChange(null, 'home_ou')">
      </eg-org-select>
    </div>
  </div>

  <div class="row pt-1 pb-1 mt-1" *ngIf="showField('au', 'profile')">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'profile'}}">
    </ng-container>
    <div class="col-lg-3">
      <eg-profile-select #profileSelect 
        [useDisplayEntries]="true"
        [initialGroupId]="patron.profile()" 
        (profileChange)="
          fieldValueChange(null, 'profile', $event ? $event.id() : null); 
          afterFieldChange(null, 'profile')">
      </eg-profile-select>
    </div>
    <div class="col-lg-6">
      <button class="btn btn-outline-dark" 
        *ngIf="hasPerm.CREATE_USER_GROUP_LINK"
        (click)="openGroupsDialog()" i18n>Secondary Groups</button>
    </div>
  </div>

  <div class="row pt-1 pb-1 mt-1" *ngIf="showField('au', 'expire_date')">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {args: {field: 'expire_date'}}">
    </ng-container>
    <div class="col-lg-3">
      <eg-date-select
        domId="au-expire_date-input"
        fieldName="au-expire_date-input"
        [noMaxWidth]="true"
        [required]="fieldRequired('au', 'expire_date')"
        [(ngModel)]="expireDate">
      </eg-date-select>
    </div>
    <div class="col-lg-6">
      <button class="btn btn-outline-dark" (click)="setExpireDate()" i18n>
        Update Expire Date
      </button>
    </div>
  </div>
</div>

