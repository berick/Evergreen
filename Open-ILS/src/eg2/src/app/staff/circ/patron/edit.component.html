
<div class="row" *ngIf="loading">
  <div class="col-lg-6 offset-lg-3">
    <eg-progress-inline></eg-progress-inline>
  </div>
</div>

<ng-template #fieldLabel  
  let-cls="cls" let-field="field" let-overrideLabel="overrideLabel">
  <div class="col-lg-3 field-label">
    <label for="{{getClass(cls)}}-{{field}}-input">
      {{getFieldLabel(getClass(cls), field, overrideLabel)}}
    </label>
    <!-- TODO doc links -->
  </div>
</ng-template>

<!-- text / number / email inputs -->
<ng-template #fieldInput 
  let-cls="cls" 
  let-path="path"
  let-field="field" 
  let-type="type" 
  let-disabled="disabled" 
  let-overrideLabel="overrideLabel">

  <ng-container 
    *ngTemplateOutlet="fieldLabel; context: 
      {cls: cls, field: field, overrideLabel: overrideLabel}">
  </ng-container>

  <div class="col-lg-3">
    <input 
      type="{{type || 'text'}}"
      class="form-control" 
      name="{{getClass(cls)}}-{{field}}-input"
      id="{{getClass(cls)}}-{{field}}-input"
      [ngModel]="objectFromPath(path)[field]()"
      (ngModelChange)="fieldValueChange(path, field, $event)"
      (change)="fieldMaybeModified(path, field)"
      [required]="fieldRequired(getClass(cls), field)"
      [pattern]="fieldPattern(getClass(cls), field)"
      [disabled]="disabled"
    />
  </div>
</ng-template>

<!-- checkbox inputs -->
<ng-template #fieldCheckbox 
  let-cls="cls" 
  let-path="path"
  let-field="field" 
  let-type="type" 
  let-disabled="disabled" 
  let-overrideLabel="overrideLabel">

  <ng-container 
    *ngTemplateOutlet="fieldLabel; context: 
      {cls: cls, field: field, overrideLabel: overrideLabel}">
  </ng-container>

  <div class="col-lg-3">
    <input 
      type="checkbox"
      class="form-check-input ml-0"
      name="{{getClass(cls)}}-{{field}}-input"
      id="{{getClass(cls)}}-{{field}}-input"
      [ngModel]="objectFromPath(path)[field]() == 't'"
      (ngModelChange)="fieldValueChange(path, field, $event)"
      (change)="fieldMaybeModified(path, field)"
      [required]="fieldRequired(getClass(cls), field)"
      [pattern]="fieldPattern(getClass(cls), field)"
      [disabled]="disabled"
    />
  </div>
</ng-template>

<!-- combobox inputs -->
<ng-template #fieldCombobox
  let-cls="cls" 
  let-path="path"
  let-field="field" 
  let-disabled="disabled" 
  let-entries="entries"
  let-overrideLabel="overrideLabel">

  <ng-container 
    *ngTemplateOutlet="fieldLabel; context: 
      {cls: cls, field: field, overrideLabel: overrideLabel}">
  </ng-container>

  <div class="col-lg-3">
    <eg-combobox [entries]="entries"
      name="{{getClass(cls)}}-{{field}}-input"
      domId="{{getClass(cls)}}-{{field}}-input"
      [startId]="getFieldValue(path, field)"
      (onChange)="
        fieldValueChange(path, field, $event ? $event.id : null); 
        fieldMaybeModified(path, field)"
      [required]="fieldRequired(getClass(cls), field)"
      [disabled]="disabled">
    </eg-combobox>
  </div>
</ng-template>

<div class="mt-3 striped-rows-even patron-edit-container" *ngIf="patron">
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: 
        {cls: 'ac', field: 'barcode', path: 'card', disabled: !patron.isnew()}">
    </ng-container>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {field: 'usrname'}">
    </ng-container>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {field: 'passwd'}">
    </ng-container>
    <div class="col-lg-3">
      <button class="btn btn-outline-dark" (click)="generatePassword()" i18n>
        Generate Password
      </button>
    </div>
  </div>
  <ul ngbNav #nameNav="ngbNav" class="nav-tabs" [(activeId)]="nameTab">
    <li ngbNavItem="primary">
      <a ngbNavLink i18n>Primary Name</a>
      <ng-template ngbNavContent>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'prefix'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'first_given_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'second_given_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'family_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'suffix'}">
          </ng-container>
        </div>
      </ng-template>
    </li>
    <li ngbNavItem="preferred">
      <a ngbNavLink i18n>Preferred Name</a>
      <ng-template ngbNavContent>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'pref_prefix'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'pref_first_given_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'pref_second_given_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'pref_family_name'}">
          </ng-container>
        </div>
        <div class="row pt-1 pb-1 mt-1">
          <ng-container 
            *ngTemplateOutlet="fieldInput; context: {field: 'pref_suffix'}">
          </ng-container>
        </div>
      </ng-template>
    </li>
  </ul>
  <div class="border rounded p-2" [ngClass]="{
    'border-primary': nameTab == 'primary', 
    'border-success': nameTab == 'preferred'}">
    <b>{{nameTab}}</b>
    <div [ngbNavOutlet]="nameNav"></div>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {field: 'name_keywords'}">
    </ng-container>
    <div class="col-lg-3">
      <textarea
        class="form-control" 
        name="au-name_keywords-input"
        id="au-name_keywords-input"
        [ngModel]="objectFromPath(null)['name_keywords']()"
        (ngModelChange)="fieldValueChange(null, 'name_keywords', $event)"
        (change)="fieldMaybeModified(null, 'name_keywords')"
        [required]="fieldRequired('au', 'name_keywords')"
        [pattern]="fieldPattern('au', 'name_keywords')">
      </textarea>
    </div>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <!-- example of overriding a field label -->
    <eg-string #holdAliasString i18n-text text="Holds Alias"></eg-string>
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: 
        {field: 'alias', overrideLabel: holdAliasString.text}">
    </ng-container>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldLabel; context: {field: 'dob'}">
    </ng-container>
    <div class="col-lg-3">
      <eg-date-select
        domId="au-dob-input"
        fieldName="au-dob-input"
        [initialIso]="patron.dob()"
        (onChangeAsIso)="
          fieldValueChange(null, 'dob', $event); 
          fieldMaybeModified(null, 'dob')"
        [required]="fieldRequired('au', 'dob')">
      </eg-date-select>
    </div>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldCheckbox; context: {field: 'juvenile'}">
    </ng-container>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldInput; context: {field: 'guardian'}">
    </ng-container>
  </div>
  <div class="row pt-1 pb-1 mt-1">
    <ng-container 
      *ngTemplateOutlet="fieldCombobox; 
        context: {field: 'ident_type', entries: identTypes}">
    </ng-container>
  </div>
</div>

